<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>鄭宇翔與陳郁芳的婚紗相簿｜Wedding Album</title>
  <meta name="robots" content="noindex" />
  <style>
    :root{ --pink1:#F8E6EE; --pink2:#FFF9FB; --gray:#A4A2A0; --ink:#2b2b2b; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
      background:linear-gradient(160deg,var(--pink1),var(--pink2));
      color:var(--ink);
    }
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter:saturate(180%) blur(10px);
      background:color-mix(in oklab, white 60%, transparent);
      border-bottom:1px solid rgba(255,255,255,.6);
    }
    .container{max-width:1100px; margin:0 auto; padding:20px}
    h1{margin:0; font-weight:700; letter-spacing:.02em}
    .sub{margin:.35rem 0 0; color:#666}

    /* 網格 */
    .grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(240px,1fr)); gap:16px; padding:24px 20px 64px}
    figure{margin:0; border-radius:16px; overflow:hidden; background:rgba(255,255,255,.7); border:1px solid rgba(255,255,255,.85); box-shadow:0 12px 30px rgba(0,0,0,.08)}
    figure a{display:block; text-decoration:none; color:inherit}
    img{display:block; width:100%; height:100%; object-fit:cover; background:#f2f2f2; image-rendering:auto}

    /* 固定縮圖比例（1:1 可改 3/2 或 16/9） */
    .thumb{aspect-ratio:1/1; position:relative; overflow:hidden; background:#f2f2f2}
    .thumb img{position:absolute; inset:0; width:100%; height:100%; object-fit:cover}

    figcaption{padding:10px 12px; font-size:.92rem; color:#555; display:none}

    /* Lightbox */
    dialog#lightbox{border:none; padding:0; border-radius:18px; max-width:min(92vw,1200px); width:fit-content; overflow:clip; box-shadow:0 30px 80px rgba(0,0,0,.35)}
    dialog::backdrop{background:rgba(0,0,0,.55)}
    .lb-wrap{position:relative; background:#000}
    .lb-img{display:block; max-width:calc(min(92vw,1200px)); max-height:85vh; width:auto; height:auto; object-fit:contain; background:#000}
    .lb-ui{position:absolute; inset:0; display:flex; align-items:center; justify-content:space-between; pointer-events:none}
    .lb-btn{pointer-events:auto; background:rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.45); color:#fff; width:44px; height:44px; display:grid; place-items:center; border-radius:50%; margin:0 8px; cursor:pointer}
    .lb-close{position:absolute; top:8px; right:8px}
    .sr-only{position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0}

    footer{padding:24px 0 60px; text-align:center; color:#777}
    .muted{color:#888}

    .hidden{display:none!important}
    .error{color:#b00020; background:#fff; border-left:4px solid #b00020; padding:12px 14px; border-radius:8px}

    /* === 右下角漂浮愛心 === */
    .fab-heart{
      position: fixed; right: 16px; bottom: 16px;
      width: 66px; height: 66px;
      border-radius: 50%;
      backdrop-filter: blur(6px) saturate(140%);
      background: rgba(255,255,255,.55);
      border: 1px solid rgba(255,255,255,.9);
      box-shadow: 0 10px 28px rgba(0,0,0,.18);
      display: grid; place-items:center;
      cursor: pointer;
      z-index: 20;
      user-select: none;
      transition: transform .15s ease, background .2s ease;
    }
    .fab-heart:hover{ transform: translateY(-2px) scale(1.02); background: rgba(255,255,255,.7); }
    .fab-heart:active{ transform: scale(.98); }
    .fab-heart svg{ width: 28px; height: 28px; opacity:.9; }
    .fab-heart .count{
      position: absolute; left: 50%; transform: translateX(-50%);
      bottom: -18px; font-size: 12px; line-height: 1;
      padding: 2px 6px; border-radius: 999px;
      background: rgba(255,255,255,.65);
      border: 1px solid rgba(255,255,255,.9);
      color: #555;
      white-space: nowrap;
      pointer-events: none;
    }
    @media (max-width:420px){
      .fab-heart{ right: 12px; bottom: 12px; width: 60px; height: 60px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>鄭宇翔與陳郁芳的婚紗相簿</h1>
      <p class="sub">ZYX & CYF Wedding Album – FerriWedding, Kaohsiung, Taiwan (2025.10.10)</p>
    </div>
  </header>

  <main class="container">
    <div id="notice" class="muted">載入中…</div>
    <div id="error" class="error hidden"></div>
    <section id="grid" class="grid" aria-live="polite"></section>
  </main>

  <footer>
    <small class="muted">Captured with Love in Taiwan</small>
  </footer>

  <!-- 漂浮愛心（先放在 DOM，等等 JS 才綁事件） -->
  <button id="fab-like" class="fab-heart" aria-label="按愛心">
    <svg viewBox="0 0 24 24" fill="#E57373" aria-hidden="true">
      <path d="M12 21s-6.716-4.324-9.38-7.02C.8 12.14.5 9.36 2.11 7.7c1.78-1.84 4.82-1.62 6.59.23L12 11l3.3-3.07c1.77-1.85 4.81-2.07 6.59-.23 1.61 1.66 1.31 4.44-.51 6.28C18.72 16.68 12 21 12 21z"/>
    </svg>
    <span id="fab-like-count" class="count">0</span>
  </button>

  <!-- 相簿主程式（不含任何按讚邏輯） -->
  <dialog id="lightbox" aria-label="照片檢視">
    <div class="lb-wrap">
      <img id="lb-img" class="lb-img" alt="" />
      <button class="lb-btn lb-close" id="lb-close" aria-label="關閉">✕</button>
      <div class="lb-ui">
        <button class="lb-btn" id="lb-prev" aria-label="上一張">‹</button>
        <span class="sr-only" id="lb-count"></span>
        <button class="lb-btn" id="lb-next" aria-label="下一張">›</button>
      </div>
    </div>
  </dialog>

  <script>
  // === GitHub 設定 ===
  const GH_USER   = "ZYXCYF";
  const GH_REPO   = "WeddingAlbum";
  const GH_BRANCH = "main";
  const FOLDER    = "WeddingPhoto";
  const THUMBS    = "_thumbs";   // 縮圖子資料夾

  // 自動判斷使用者/專案頁
  try{
    const host = location.hostname;
    const parts = location.pathname.replace(/^\//,'').split('/');
    if(host.includes('.github.io')){
      const username = host.split('.github.io')[0];
      if(GH_USER === "USERNAME") window.GH_USER_AUTO = username;
      if(GH_REPO === "REPOSITORY"){
        const maybeRepo = parts[0] || `${username}.github.io`;
        window.GH_REPO_AUTO = maybeRepo;
      }
    }
  }catch(e){}

  const user   = window.GH_USER_AUTO || GH_USER;
  const repo   = window.GH_REPO_AUTO || GH_REPO;
  const branch = GH_BRANCH;

  const grid   = document.getElementById('grid');
  const notice = document.getElementById('notice');
  const errBox = document.getElementById('error');

  const ALLOWED = new Set(['.jpg','.jpeg','.png','.webp','.gif','.avif']);
  const photos = [];

  function fileExt(name){
    const i = name.lastIndexOf('.');
    return i>=0 ? name.slice(i).toLowerCase() : '';
  }
  function stem(name){ return name.replace(/\.[^.]+$/,'').toLowerCase(); }
  function niceCaption(name){
    return name.replace(/^(.+)(\.[^.]+)$/,'$1').replace(/[_-]+/g,' ').replace(/\s+/g,' ').trim();
  }

  function makeCard({thumb, full, name}, i){
    const fig = document.createElement('figure');
    const a = document.createElement('a'); a.href = full; a.setAttribute('data-name', name);

    const box = document.createElement('div'); box.className = 'thumb';
    const img = document.createElement('img');
    if(i < 6) img.setAttribute('fetchpriority','high');
    img.loading = 'lazy';
    img.decoding = 'async';
    img.alt = niceCaption(name);
    img.src = thumb;
    box.appendChild(img);

    a.appendChild(box);
    a.addEventListener('click', ev => { ev.preventDefault(); openLightbox(full); });

    fig.appendChild(a);
    return fig;
  }

  // Lightbox
  const lb = document.getElementById('lightbox');
  const lbImg = document.getElementById('lb-img');
  const lbPrev = document.getElementById('lb-prev');
  const lbNext = document.getElementById('lb-next');
  const lbClose = document.getElementById('lb-close');
  let idx = -1;

  function openLightbox(url){
    idx = photos.findIndex(p => p.url === url);
    if(idx < 0) idx = 0;
    updateLB();
    if(!lb.open) lb.showModal();
  }
  function updateLB(){
    const p = photos[idx];
    lbImg.src = p.url; lbImg.alt = p.name;
  }
  function step(d){
    if(!photos.length) return;
    idx = (idx + d + photos.length) % photos.length;
    updateLB();
  }
  lbPrev.addEventListener('click', ()=> step(-1));
  lbNext.addEventListener('click', ()=> step(+1));
  lbClose.addEventListener('click', ()=> lb.close());
  lb.addEventListener('click', e=>{ if(e.target === lb) lb.close(); });
  window.addEventListener('keydown', e=>{
    if(!lb.open) return;
    if(e.key==='ArrowLeft') step(-1);
    else if(e.key==='ArrowRight') step(+1);
    else if(e.key==='Escape') lb.close();
  });

  // 讀取 GitHub 目錄清單
  async function listFolder(path){
    const url = `https://api.github.com/repos/${user}/${repo}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(branch)}`;
    const r = await fetch(url, {headers:{'Accept':'application/vnd.github+json'}});
    if(r.status===404 && branch==='main'){
      const url2 = url.replace('ref=main','ref=master');
      const r2 = await fetch(url2,{headers:{'Accept':'application/vnd.github+json'}});
      if(r2.ok) return r2.json();
    }
    if(!r.ok) throw new Error(await r.text());
    return r.json();
  }

  // 分批渲染
  function batchedRender(items, renderOne, batchSize = 15){
    let i = 0;
    const schedule = (typeof window.requestIdleCallback === 'function')
      ? (cb) => window.requestIdleCallback(cb)
      : (cb) => setTimeout(cb, 0);

    function more(){
      const end = Math.min(i + batchSize, items.length);
      for (; i < end; i++) renderOne(items[i], i);
      if (i < items.length) schedule(more);
    }
    more();
  }

  async function load(){
    try{
      const [files, thumbs] = await Promise.all([
        listFolder(FOLDER),
        listFolder(`${FOLDER}/${THUMBS}`).catch(()=>[]),
      ]);

      const thumbMap = new Map(
        (Array.isArray(thumbs)?thumbs:[])
          .filter(it => it.type === 'file')
          .map(it => [ stem(it.name), it.download_url ])
      );

      const imgs = files.filter(it => it.type==='file' && ALLOWED.has(fileExt(it.name)));
      if(!imgs.length){
        notice.textContent = `資料夾沒有圖片；請放 .jpg/.png/.webp 等檔案到 ${FOLDER}/`;
        return;
      }
      notice.classList.add('hidden');

      imgs.sort((a,b)=> a.name.localeCompare(b.name, undefined, {numeric:true, sensitivity:'base'}));

      batchedRender(imgs, (f, i)=>{
        const full  = f.download_url;
        const th    = thumbMap.get(stem(f.name)) || full;
        photos.push({ url: full, name: f.name });
        grid.appendChild(makeCard({ thumb: th, full, name: f.name }, i));
      });

      grid.addEventListener('mouseover', (e)=>{
        const a = e.target.closest('a');
        if(!a) return;
        const href = a.getAttribute('href');
        const link = document.createElement('link');
        link.rel='prefetch'; link.href=href; document.head.appendChild(link);
      });

    }catch(err){
      console.error(err);
      notice.classList.add('hidden');
      errBox.classList.remove('hidden');
      errBox.textContent = '讀取相片清單失敗：' + (err.message || err);
    }
  }
  load();
  </script>

  <!-- 全站共享愛心邏輯（只此一顆） -->
  <script>
  // 用你的 GAS Web App URL（此為你提供的 URL）
  const GAS_URL = "https://script.google.com/macros/s/AKfycbyBSlGxC4NA7FxFar67iECcLuc5liqW63YJ8YbDH7u9qDCPgnud6rqWwWo4xQNZJ7dY/exec";

  const $fab = document.getElementById('fab-like');
  const $count = document.getElementById('fab-like-count');

  let currentLikes = 0;
  let pendingAdds = 0;
  let flushTimer = null;
  let inflight = false;

  function formatCount(n){
    if(n >= 1e9) return (n/1e9).toFixed(1).replace(/\.0$/,'')+'B';
    if(n >= 1e6) return (n/1e6).toFixed(1).replace(/\.0$/,'')+'M';
    if(n >= 1e3) return (n/1e3).toFixed(1).replace(/\.0$/,'')+'K';
    return String(n);
  }

  function renderCount(){
    $count.textContent = formatCount(currentLikes + pendingAdds);
  }

  async function fetchLikes(){
    try{
      const r = await fetch(GAS_URL + "?t=" + Date.now());
      const data = await r.json();
      if(typeof data.likes === "number"){
        currentLikes = data.likes;
        renderCount();
      }
    }catch(e){ console.warn("Fetch failed", e); }
  }

  function queueLike(){
    pendingAdds++;
    renderCount();
    if(!flushTimer) flushTimer = setTimeout(flushLikes, 300);
  }

  async function flushLikes(){
    flushTimer = null;
    if(pendingAdds <= 0 || inflight) return;
    const add = pendingAdds; pendingAdds = 0; inflight = true;
    try{
      const r = await fetch(GAS_URL, {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({inc:add})
      });
      const data = await r.json();
      if(typeof data.likes === "number") currentLikes = data.likes;
    }catch(e){
      // 網路失敗：先樂觀累計，之後再被 GET 校正
      currentLikes += add;
    }finally{
      inflight = false;
      renderCount();
    }
  }

  $fab.addEventListener("click", queueLike, {passive:true});
  fetchLikes();
  </script>
</body>
</html>
